---
title: "Single-label replication"
output: html_notebook
---

# Setup

In order to load the data, the *here* library is used to access the path with respect to the working directory of the project (CRIS_single-sample folder, which contains the .Rproj file). 

```{r setup}
library(here)
source(here('src','load_libraries.r'))
source(here('src','utils','source_utils.r'))
source(here('src','loader_writer','load_data.r'))
source(here('src','data_management','source_data_management.r'))
source(here('src','classifiers','source_classifiers.r'))
source(here('src','pipelines','source_pipelines.r'))
```

# Data loading

The single-label classifiers are trained on training TCGA data samples. The data can be loaded with:

```{r sldata}
sldata <- load_prepared_tcga_data(confident = 'conf',
                                  uniformed = TRUE,
                                  fs_type = 'ntp_only',
                                  type = 'sl',
                                  load_training = TRUE)
```

The structure of training data (accessed with *train_* field) and its corresponding reference (*train_ref* field) can be inspected with:

```{r train_data_structure}
head(sldata$train_)
head(sldata$train_ref)
```

# The generic single-label classifier model

The single-label classifier models are actually functions that describe the class label as function of the feature genes. Therefore, the formula to model the classifiers is:

```{r sl_formula}
.SL_FORMULA
```

Obviously, the class label is included in the training data.

```{r check_train_data}
CLASS_LABEL %in% colnames(sldata$train_)
```

The methods that can be used to train single-label classifiers are hold in:

```{r sl_available_models}
methods
```

# Training with default hyperparameter tuning

The formula described above is used within the library *caret* to model the single-label classifier. In order to train the model with default tuning (provided by caret).

```{r default_training}
sl_train <- sl_pipeline_train(sldata = sldata,
                              method = methods[1],           # linear SVM, one of the applied models
                              sl_formula = .SL_FORMULA,
                              seed = .SEED)
```

The obtained model can be accessed with:

```{r lsvm_default_tuning}
lsvm_default <- sl_train$model
```

# Training with custom tuning

It is possible to tune the model with custom tuning values, which are defined in *src/classifiers/classifiers_settings.r*. In order to do this, it is sufficient to provide a *trainControl* settings (defined in the above script as *fit_control*) and a list of tuning values, which can be accessed using the method name as follows:

```{r lsvm_tuning_grid}
# Linear SVM tuning values
tune_grid[[methods[1]]]
```

The function to be called in order to train a linear SVM with custom tuning is the following:

```{r custom_tuning_function}
sl_train_tuned <- sl_pipeline_train(sldata = sldata,
                                    method = methods[1],      # linear SVM, one of the applied models
                                    sl_formula = .SL_FORMULA,
                                    seed = .SEED,
                                    tune = TRUE,
                                    fit_control = fit_control,
                                    tune_grid = tune_grid[[methods[1]]])
```

As before, the model can be extracted with:

```{r custom_tuned_lsvm}
lsvm_custom <- sl_train_tuned$model
```

# Testing of the model

In order to test the obtained model, it is possible to use a custom testing pipeline, providing both the sldata and the obtained model.

```{r testing_default_model}

lsvm_default_testing <- sl_pipeline_test(sldata = sldata,
                                         method = methods[1],
                                         seed = .SEED,
                                         model = lsvm_default)

```

The performance of the classification can be visualized with

```{r performance_default_model}

print(lsvm_default_testing$metrics)

```

Similarly, for the custom model:

```{r testing_custom_model}

lsvm_custom_testing <- sl_pipeline_test(sldata = sldata,
                                         method = methods[1],
                                         seed = .SEED,
                                         model = lsvm_custom)
print(lsvm_custom_testing$metrics)
```

# Biological validation








